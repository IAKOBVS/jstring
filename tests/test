#!/bin/sh

FLAGS='
-g
-std=c99
-Wall
-Wextra
-Wpedantic
'

has_prog()
{
	type "$1" >/dev/null 2>/dev/null
}

compile()
{
	file=$1
	args=$(echo "$*" | cut -d' ' -f3-)
	if [ $CC = 'tcc' ]; then
		#shellcheck disable=disable=SC2086
		$CC $FLAGS $args -run "$file" $args
	else
		file=$1
		out=$2
		out=$out$(echo "$args" | tr -d ' ')
		#shellcheck disable=disable=SC2086
		$CC "$file" -o "$out" $FLAGS $args
		"$out"
		rm "$out"
	fi
}

cd "$(dirname "$0")" || exit

if false; then
	CC=tcc
else
	CC=cc
	# In GCC, -O1 compiles faster.
	[ "$(readlink "$(command -v cc)")" = 'gcc' ] && FLAGS="$FLAGS -O1"
	# Set the path to compile the tests to.
	if [ -z "$TMPDIR" ]; then
		if [ -d /tmp ]; then
			TMPDIR=/tmp/$tmp
		else
			TMPDIR=$PWD/$tmp
		fi
	fi
	tmp="$TMPDIR"__$(echo "$PWD" | sed 's/\///g; s/\.//g')-
fi

# Test all files in arguments. Otherwise, test all.
if [ $# -eq 0 ]; then
	files=$(echo *.c)
else
	files=$*
fi

for file in $files; do
	out_file=${file%.*}
	compile "$file" "$tmp$out_file" -DJSTR_HAVE_ATTR_MAY_ALIAS=1 -DJSTR_USE_LGPL=1 &
	compile "$file" "$tmp$out_file" -DJSTR_HAVE_ATTR_MAY_ALIAS=0 -DJSTR_USE_LGPL=0 &
	compile "$file" "$tmp$out_file" -DJSTR_HAVE_ATTR_MAY_ALIAS=0 -DJSTR_USE_LGPL=1 &
	compile "$file" "$tmp$out_file" -DJSTR_HAVE_ATTR_MAY_ALIAS=1 -DJSTR_USE_LGPL=0 &
done
wait
