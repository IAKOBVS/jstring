#!/bin/sh

FLAGS='
-g
-std=c99
-Wall
-Wextra
-Wpedantic
'

if false && type clang >/dev/null 2>/dev/null; then
	FLAGS="$FLAGS -O0"
	CC=clang
else
	FLAGS="$FLAGS -O1"
	CC=cc
fi

compile()
{
	file=$1
	out=$2
	args=$(echo "$*" | cut -d' ' -f3-)
	out=$out$(echo "$args" | tr -d ' ')
	#shellcheck disable=disable=SC2086
	$CC "$file" -o "$out" $FLAGS $args
	"$out"
	rm "$out"
}

cd "$(dirname "$0")" || exit

mktemp=__$(echo "$PWD" | sed 's/\///g; s/\.//g')-
if [ "$TMPDIR" ]; then
	TMPDIR=$TMPDIR/$mktemp
elif [ -d /tmp ]; then
	TMPDIR=/tmp/$mktemp
else
	TMPDIR=$PWD/$mktemp
fi

if [ $# -eq 0 ]; then
	files=$(echo *.c)
else
	files=$*
fi

for file in $files; do
	out_file=${file%.*}
	compile "$file" "$TMPDIR$out_file" -DJSTR_HAVE_ATTR_MAY_ALIAS=1 -DJSTR_USE_LGPL=1 &
	compile "$file" "$TMPDIR$out_file" -DJSTR_HAVE_ATTR_MAY_ALIAS=0 -DJSTR_USE_LGPL=0 &
	compile "$file" "$TMPDIR$out_file" -DJSTR_HAVE_ATTR_MAY_ALIAS=0 -DJSTR_USE_LGPL=1 &
	compile "$file" "$TMPDIR$out_file" -DJSTR_HAVE_ATTR_MAY_ALIAS=1 -DJSTR_USE_LGPL=0 &
done
wait
