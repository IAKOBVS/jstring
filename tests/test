#!/bin/sh

# See LICENSE file for copyright and license details.

compile()
{
	file=$1
	out=$2
	shift 2
	#shellcheck disable=SC2068
	echo "cc $file -o $out $@ $flags"
	cc "$file" -o "$out" $@ $flags
	./"$out"
	rm ./"$out"
}

cd "$(dirname "$0")" || exit
if [ $# -eq 0 ]; then
	files=$(echo *.c)
else
	files=$*
	shift
fi

flags="-fsanitize=address -g $* -O1"

echo "$files"
for file in $files; do
	out=${file%.*}
	compile "$file" "$out" &
	compile "$file" "$out"_JSTR_USE_LGPL_0 -DJSTR_USE_LGPL=0 &
	compile "$file" "$out"_JSTR_HAVE_ATTR_MAY_ALIAS_0 -DJSTR_HAVE_ATTR_MAY_ALIAS=0 &
done
wait
