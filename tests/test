#!/bin/sh
#shellcheck disable=disable=SC2086

CFLAGS="
-g
-std=c99
-Wall
-Wextra
-Wpedantic
-Wsign-conversion
-DJSTR_TEST_SLOW=1
-O2
$CFLAGS
"

has_prog()
{
	type "$1" >/dev/null 2>/dev/null
}

compile()
{
	file=$1
	args=$(echo "$*" | cut -d' ' -f3-)
	file=$1
	out=$2
	out=$out$(echo "$args" | tr -d ' ')
	$CC "$file" -o "$out" $CFLAGS $args
	"$out"
	rm "$out"
}

cd "$(dirname "$0")" || exit

CC="$(readlink "$(command -v cc)")"
# Set the path to compile the tests to.
if [ -z "$TMPDIR" ]; then
	if [ -d /tmp ]; then
		TMPDIR=/tmp
	else
		TMPDIR=$(echo "$PWD" | head -c 255)
	fi
else
	TMPDIR=$TMPDIR/
fi
tmp="$TMPDIR"/$(echo "$PWD" | sed 's/\///g; s/\.//g')
mkdir -p "$tmp"
echo 'This might take a while.'

# Test all files in arguments. Otherwise, test all.
if [ $# -eq 0 ]; then
	files=$(echo *.c)
else
	files=$*
fi

for file in $files; do
	out_file=${file%.*}
	compile "$file" "$tmp$out_file" $CFLAGS -mtune=generic &
	compile "$file" "$tmp$out_file" $CFLAGS -march=native &
done
wait

rm -rf "$tmp"
