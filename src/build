#!/bin/sh

cd "$(dirname "$0")" || exit
./setup || exit
./test || exit
mkdir -p ../jstr
update_if_needed()
{
	in_fname=$1
	out_fname=../jstr/$in_fname
	test -e "$out_fname" && test "$in_fname" -ot "$out_fname" && exit 0
	case $in_fname in
	*macro*) ;;
	*_jstr-*) perl ./namespace-macros.pl "$in_fname" > "$out_fname"
		exit 0
		;;
	*jstr-*)
		perl ./gen-func.pl "$in_fname" | perl ./namespace-macros.pl >"$out_fname"
		exit 0
		;;
	*) ;;
	esac
	cp -f "$in_fname" "$out_fname"
}
for file in $(echo *.h); do
	update_if_needed "$file" &
done
wait
compile()
{
	file=$1
	shift
	#shellcheck disable=SC2068
	cc -x c $@ -Wall -Wextra -o "$file" -
}
file_str='#include "../jstr/jstr.h"
int main(void) {return 0;}'
TMP=/tmp/__jstr_tmp_obj__
echo "$file_str" | compile "$TMP"1 || exit &
echo "$file_str" | compile "$TMP"2 -D__STRICT_ANSI__ || exit &
echo "$file_str" | compile "$TMP"3 -DJSTR_USE_LGPL=0 || exit &
wait
rm -f "$TMP"1
rm -f "$TMP"2
rm -f "$TMP"3
echo 'Built to jstr.'
