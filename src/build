#!/bin/sh

cd "$(dirname "$0")" || exit
./setup || exit
mkdir -p ../jstr
update_if_needed()
{
	in_fname=$1
	out_fname=../jstr/$in_fname
	test -e "$out_fname" && test "$in_fname" -ot "$out_fname" && exit 0
	case $in_fname in
	*macro*) ;;
	*_jstr-*)
		perl ./namespace-macros.pl "$in_fname" >"$out_fname"
		exit 0
		;;
	*jstr-*)
		perl ./gen-func.pl "$in_fname" | perl ./namespace-macros.pl >"$out_fname"
		exit 0
		;;
	*) ;;
	esac
	cp -f "$in_fname" "$out_fname"
}
compile()
{
	file=$1
	shift
	#shellcheck disable=SC2068
	cc -x c $@ -Wall -Wextra -o "$file" -
}
mark_as_built()
{
	#shellcheck disable=SC2005
	echo "$(sed 's/\([ \t]*#[ \t]*ifndef[ \t]\{1,\}JSTR_BUILT\)/#define JSTR_BUILT\n\1/' ../jstr/jstr-macros.h)" >../jstr/jstr-macros.h
}
for file in $(echo *.h); do
	update_if_needed "$file" &
done
wait
mark_as_built
./test || exit
echo 'Built to jstr.'
